generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserType {
  INDIVIDUAL
  BUSINESS
  ADMIN
}

enum AccountVisibility {
  PUBLIC
  PRIVATE
}

enum OnboardingStep {
  ACCOUNT_CREATED
  BASIC_INFO_COMPLETED
  PROFILE_PICTURE_UPLOADED
  BIO_COMPLETED
  BUSINESS_INFO_COMPLETED
  PROFILE_COMPLETED
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum PostType {
  IMAGE
  TEXT
  VIDEO
  DOCUMENT
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum UserTypeChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  VIDEO
}

enum NotificationType {
  CONNECTION_REQUEST
  CONNECTION_ACCEPTED
  POST_LIKE
  POST_COMMENT
  POST_SHARE
  EVENT_REMINDER
  EVENT_ENROLLMENT
  EVENT_APPROVED
  MESSAGE_RECEIVED
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  MEETING_INVITE
  SYSTEM_ANNOUNCEMENT
}

// ============================================================================
// CATEGORY MODEL
// ============================================================================

model Category {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  posts       Post[]
  events      Event[]

  @@index([isActive])
}

// ============================================================================
// COMPANY MODEL
// ============================================================================

model Company {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  slug        String   @unique
  logo        String?

  industry    String?
  gstNumber   String?
  website     String?

  description String?
  location    String?

  isVerified  Boolean  @default(false)
  verifiedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  posts       Post[]   @relation("CompanyPosts")
  events      Event[]  @relation("CompanyEvents")

  @@index([isVerified])
}

// ============================================================================
// USER MODEL
// ============================================================================

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String
  username  String   @unique

  avatar    String?
  bio       String?
  phone     String?
  location  String?
  website   String?

  userType   UserType @default(INDIVIDUAL)
  visibility AccountVisibility @default(PUBLIC)

  verificationStatus VerificationStatus @default(UNVERIFIED)
  verifiedAt         DateTime?
  verificationNote   String?

  onboardingStep     OnboardingStep @default(ACCOUNT_CREATED)
  isProfileCompleted Boolean @default(false)
  profileCompletedAt DateTime?

  categoryId  String?   @db.ObjectId
  category    Category? @relation(fields: [categoryId], references: [id])
  interests   String[]

  companyId       String?  @db.ObjectId
  company         Company? @relation(fields: [companyId], references: [id])

  companyName     String?
  companyLogo     String?
  turnover        String?
  companySize     String?
  industry        String?
  gstNumber       String?
  establishedYear String?
  companyWebsite  String?

  linkedin  String?
  twitter   String?
  facebook  String?
  instagram String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts        Post[]
  enrollments  EventEnrollment[]
  organizedEvents Event[] @relation("EventOrganizer")
  userTypeChangeRequests UserTypeChangeRequest[]
  
  connectionsSent     Connection[] @relation("ConnectionsSent")
  connectionsReceived Connection[] @relation("ConnectionsReceived")
  messages            Message[]
  notifications       Notification[]
  postLikes           PostLike[]
  postComments        PostComment[]

  @@index([userType])
  @@index([verificationStatus])
  @@index([isProfileCompleted])
  @@index([companyId])
  @@index([categoryId])
}

// ============================================================================
// USER TYPE CHANGE REQUEST
// ============================================================================

model UserTypeChangeRequest {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId

  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fromType  UserType
  toType    UserType

  reason    String?

  companyId       String?  @db.ObjectId
  companyName     String?
  companyLogo     String?
  turnover        String?
  companySize     String?
  industry        String?
  gstNumber       String?
  establishedYear String?
  companyWebsite  String?

  status          UserTypeChangeStatus @default(PENDING)

  reviewedBy      String?  @db.ObjectId
  reviewedAt      DateTime?
  reviewNote      String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// POST MODEL
// ============================================================================

model Post {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  type        PostType
  content     String
  images      String[]
  tags        String[]

  visibility  AccountVisibility @default(PUBLIC)

  views       Int      @default(0)
  likes       Int      @default(0)
  shares      Int      @default(0)

  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyId   String?  @db.ObjectId
  company     Company? @relation("CompanyPosts", fields: [companyId], references: [id])

  categoryId  String?  @db.ObjectId
  category    Category? @relation(fields: [categoryId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  postLikes    PostLike[]
  postComments PostComment[]

  @@index([userId])
  @@index([companyId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([visibility])
  @@index([type])
}

// ============================================================================
// POST ENGAGEMENT MODELS
// ============================================================================

model PostLike {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  postId    String   @db.ObjectId
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostComment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  postId    String   @db.ObjectId
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  
  parentId  String?  @db.ObjectId
  
  likes     Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([postId])
  @@index([userId])
}

// ============================================================================
// CONNECTION MODEL
// ============================================================================

model Connection {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  requesterId String   @db.ObjectId
  requester   User     @relation("ConnectionsSent", fields: [requesterId], references: [id], onDelete: Cascade)
  
  receiverId  String   @db.ObjectId
  receiver    User     @relation("ConnectionsReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  
  status      ConnectionStatus @default(PENDING)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([requesterId, receiverId])
  @@index([requesterId])
  @@index([receiverId])
  @@index([status])
}

// ============================================================================
// MESSAGING MODELS
// ============================================================================

model Conversation {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  
  participantIds String[] @db.ObjectId
  
  lastMessageAt DateTime @default(now())
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  messages      Message[]
  
  @@index([participantIds])
  @@index([lastMessageAt])
}

model Message {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  
  conversationId String   @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId       String   @db.ObjectId
  sender         User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  content        String
  messageType    MessageType @default(TEXT)
  
  attachments    String[]
  
  readBy         String[] @db.ObjectId
  readAt         DateTime?
  
  isEdited       Boolean  @default(false)
  isDeleted      Boolean  @default(false)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================================================
// NOTIFICATION MODEL
// ============================================================================

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String
  
  entityType String?
  entityId   String?  @db.ObjectId
  
  senderId   String?  @db.ObjectId
  
  isRead     Boolean  @default(false)
  readAt     DateTime?
  
  emailSent  Boolean  @default(false)
  pushSent   Boolean  @default(false)
  
  createdAt  DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}

// ============================================================================
// EVENT MODEL
// ============================================================================

model Event {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  slug        String   @unique
  description String

  eventType   String

  categoryId  String?  @db.ObjectId
  category    Category? @relation(fields: [categoryId], references: [id])

  startDate   DateTime
  endDate     DateTime
  timezone    String   @default("Asia/Kolkata")

  isOnline    Boolean  @default(false)
  venue       String?
  meetingLink String?

  maxAttendees Int?
  currentAttendees Int @default(0)

  visibility  AccountVisibility @default(PUBLIC)
  status      EventStatus @default(DRAFT)

  organizerId String   @db.ObjectId
  organizer   User     @relation("EventOrganizer", fields: [organizerId], references: [id])

  companyId   String?  @db.ObjectId
  company     Company? @relation("CompanyEvents", fields: [companyId], references: [id])

  targetUserTypes     String[]
  targetCategoryIds   String[]
  targetTurnoverRange String?
  targetCompanySize   String?

  coverImage  String?
  images      String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  enrollments EventEnrollment[]

  @@index([organizerId])
  @@index([companyId])
  @@index([categoryId])
  @@index([startDate])
  @@index([status])
  @@index([visibility])
}

// ============================================================================
// EVENT ENROLLMENT
// ============================================================================

model EventEnrollment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId

  eventId   String   @db.ObjectId
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  status    EnrollmentStatus @default(PENDING)

  approvedAt DateTime?
  approvedBy String?  @db.ObjectId

  attended   Boolean  @default(false)
  attendedAt DateTime?

  userNote   String?
  adminNote  String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}
